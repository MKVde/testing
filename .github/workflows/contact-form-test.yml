name: Contact Form Load Test

on:
  workflow_dispatch:
    inputs:
      instances:
        description: 'Number of parallel tests (1-100)'
        required: true
        default: '10'
        type: choice
        options:
          - '1'
          - '5'
          - '10'
          - '20'
          - '30'
          - '50'
          - '75'
          - '100'

jobs:
  form-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        instance: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100]
      max-parallel: 100
      fail-fast: false
    
    steps:
      - name: Check if should run
        id: check
        run: |
          if [ ${{ matrix.instance }} -le ${{ github.event.inputs.instances }} ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping instance ${{ matrix.instance }}"
          fi

      - name: Checkout code
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        if: steps.check.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        if: steps.check.outputs.should_run == 'true'
        run: npm install

      - name: Install Playwright Browsers with System Dependencies
        if: steps.check.outputs.should_run == 'true'
        run: npx playwright install --with-deps chromium

      - name: Setup Virtual Display (Xvfb)
        if: steps.check.outputs.should_run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2

      - name: Create Screenshots Folder
        if: steps.check.outputs.should_run == 'true'
        run: mkdir -p test-results/instance-${{ matrix.instance }}

      - name: Run Form Submission Test
        if: steps.check.outputs.should_run == 'true'
        run: node test-form.js
        env:
          INSTANCE_NUM: ${{ matrix.instance }}
          TARGET_URL: https://freightcore.ae
          DISPLAY: :99
        continue-on-error: true

      - name: List Generated Screenshots
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "Screenshots generated:"
          ls -lah test-results/instance-${{ matrix.instance }}/

      - name: Upload Screenshots as Artifact
        if: steps.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-instance-${{ matrix.instance }}
          path: test-results/instance-${{ matrix.instance }}/
          retention-days: 7

  commit-results:
    needs: form-test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts/

      - name: Organize Screenshots
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RESULTS_DIR="test-results/run-${TIMESTAMP}"
          mkdir -p "$RESULTS_DIR"
          
          if [ -d "downloaded-artifacts" ]; then
            for artifact_dir in downloaded-artifacts/screenshots-instance-*; do
              if [ -d "$artifact_dir" ]; then
                instance_name=$(basename "$artifact_dir")
                instance_num=$(echo "$instance_name" | grep -oP '\d+')
                target_dir="$RESULTS_DIR/instance-${instance_num}"
                mkdir -p "$target_dir"
                cp -r "$artifact_dir"/* "$target_dir/" 2>/dev/null || true
                echo "âœ“ Copied screenshots from $instance_name"
              fi
            done
          fi
          
          echo "RESULTS_DIR=$RESULTS_DIR" >> $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: Create Test Summary
        run: |
          RESULTS_DIR="${{ env.RESULTS_DIR }}"
          
          cat > "$RESULTS_DIR/SUMMARY.md" << 'EOF'
          # ðŸ“Š Load Test Results
          
          **Date:** $(date)
          **Instances Run:** ${{ github.event.inputs.instances }}
          **Target URL:** https://freightcore.ae
          **Run ID:** ${{ github.run_id }}
          
          ---
          
          ## ðŸ“¸ Screenshots by Instance
          
          EOF
          
          for i in $(seq 1 ${{ github.event.inputs.instances }}); do
            echo "### Instance $i" >> "$RESULTS_DIR/SUMMARY.md"
            echo "" >> "$RESULTS_DIR/SUMMARY.md"
            
            if [ -d "$RESULTS_DIR/instance-$i" ]; then
              for screenshot in "$RESULTS_DIR/instance-$i"/*.png; do
                if [ -f "$screenshot" ]; then
                  filename=$(basename "$screenshot")
                  echo "![Screenshot](./instance-$i/$filename)" >> "$RESULTS_DIR/SUMMARY.md"
                  echo "" >> "$RESULTS_DIR/SUMMARY.md"
                fi
              done
            else
              echo "*No screenshots found for this instance*" >> "$RESULTS_DIR/SUMMARY.md"
            fi
            
            echo "" >> "$RESULTS_DIR/SUMMARY.md"
          done
          
          echo "âœ… Summary created"

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and Push Screenshots
        run: |
          git add test-results/
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            git commit -m "ðŸ¤– Add load test results - Run ${{ env.TIMESTAMP }} (${{ github.event.inputs.instances }} instances)"
            git push
            echo "âœ… Screenshots committed and pushed to repository"
            echo "ðŸ“ Results saved to: test-results/run-${{ env.TIMESTAMP }}"
          fi

      - name: Generate Workflow Summary
        run: |
          echo "## ðŸŽ‰ Load Test Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“Š Test Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Instances Run:** ${{ github.event.inputs.instances }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target URL:** https://freightcore.ae" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** ${{ env.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“ Results Location:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "test-results/run-${{ env.TIMESTAMP }}/" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Screenshots have been committed to the repository." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
