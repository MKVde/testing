name: Contact Form Load Test

on:
  workflow_dispatch:
    inputs:
      instances:
        description: 'Number of parallel tests (1-10)'
        required: true
        default: '5'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'
          - '7'
          - '10'

jobs:
  form-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        instance: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
      max-parallel: 10
      fail-fast: false
    
    # Only run the selected number of instances
    if: matrix.instance <= fromJSON(github.event.inputs.instances)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Install Playwright Browsers with System Dependencies
        run: npx playwright install --with-deps chromium

      - name: Setup Virtual Display (Xvfb)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          # Start Xvfb on display :99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2

      - name: Create Screenshots Folder
        run: mkdir -p test-results/instance-${{ matrix.instance }}

      - name: Run Form Submission Test
        run: node test-form.js
        env:
          INSTANCE_NUM: ${{ matrix.instance }}
          TARGET_URL: https://freightcore.ae
          DISPLAY: :99
        continue-on-error: true

      - name: List Generated Screenshots
        run: |
          echo "Screenshots generated:"
          ls -lah test-results/instance-${{ matrix.instance }}/

  commit-results:
    needs: form-test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-results/
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Setup Virtual Display
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2

      - name: Re-run Tests to Generate Screenshots
        run: |
          for i in $(seq 1 ${{ github.event.inputs.instances }}); do
            echo "Running instance $i..."
            mkdir -p test-results/instance-$i
            INSTANCE_NUM=$i TARGET_URL=https://freightcore.ae DISPLAY=:99 node test-form.js || true
          done

      - name: Create Test Summary
        run: |
          echo "# ðŸ“Š Load Test Results" > test-results/SUMMARY.md
          echo "" >> test-results/SUMMARY.md
          echo "**Date:** $(date)" >> test-results/SUMMARY.md
          echo "**Instances Run:** ${{ github.event.inputs.instances }}" >> test-results/SUMMARY.md
          echo "**Target URL:** https://freightcore.ae" >> test-results/SUMMARY.md
          echo "" >> test-results/SUMMARY.md
          echo "## Screenshots by Instance" >> test-results/SUMMARY.md
          echo "" >> test-results/SUMMARY.md
          
          for i in $(seq 1 ${{ github.event.inputs.instances }}); do
            echo "### Instance $i" >> test-results/SUMMARY.md
            if [ -d "test-results/instance-$i" ]; then
              ls test-results/instance-$i/*.png 2>/dev/null | while read file; do
                filename=$(basename "$file")
                echo "- ![Screenshot](./$filename)" >> test-results/SUMMARY.md
              done
            fi
            echo "" >> test-results/SUMMARY.md
          done

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit Screenshots to Repository
        run: |
          # Create timestamped folder
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RESULTS_DIR="test-results/run-${TIMESTAMP}"
          mkdir -p "$RESULTS_DIR"
          
          # Copy all screenshots to timestamped folder
          cp -r test-results/instance-* "$RESULTS_DIR/" 2>/dev/null || true
          cp test-results/SUMMARY.md "$RESULTS_DIR/" 2>/dev/null || true
          
          # Add to git
          git add test-results/
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Add test results from run ${TIMESTAMP} (${{ github.event.inputs.instances }} instances)"
            git push
            echo "âœ… Screenshots committed and pushed to repository"
          fi

      - name: Generate Summary
        run: |
          echo "### Load Test Completed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Instances run:** ${{ github.event.inputs.instances }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** https://freightcore.ae" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Screenshots have been committed to the repository under \`test-results/\` folder." >> $GITHUB_STEP_SUMMARY
